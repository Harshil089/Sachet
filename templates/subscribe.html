{% extends "base.html" %}

{% block title %}Subscribe for Alerts{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-bell me-2"></i>Subscribe for Local SMS Alerts</h4>
            </div>
            <div class="card-body">
                <p class="text-muted">Enter your phone number and choose your preferred location to receive alerts when a case is reported nearby. You will receive an OTP to verify your number.</p>
                <form id="subscribeForm" onsubmit="return false;">
                    <div class="mb-3">
                        <label for="phone_number" class="form-label">Phone Number *</label>
                        <input type="tel" class="form-control" id="phone_number" placeholder="+91 98765 43210" required>
                        <div class="form-text">India only. Enter a 10-digit mobile or +91 format.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Preferred Alert Location *</label>
                        <input type="text" id="location_input" class="form-control" placeholder="Enter city/area" required>
                        <div id="map" style="height: 300px; margin-top: 10px;" class="d-none"></div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <label class="form-label">Radius (km)</label>
                                <input type="number" id="radius_km" class="form-control" value="5" min="1" max="50">
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button id="startVerifyBtn" type="button" class="btn btn-primary">Send Verification Code</button>
                    </div>

                    <div id="verifySection" class="mt-3 d-none">
                        <label for="code" class="form-label">Enter OTP</label>
                        <input type="text" class="form-control" id="code" placeholder="123456">
                        <div class="d-grid gap-2 mt-2">
                            <button id="checkVerifyBtn" type="button" class="btn btn-success">Verify & Subscribe</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <input type="hidden" id="lat">
    <input type="hidden" id="lng">
{% endblock %}

{% block scripts %}
<script>
let map, marker;
let geocodeTimer;

const $ = (id) => document.getElementById(id);

$('#location_input').addEventListener('input', function() {
    const value = this.value.trim();
    if (geocodeTimer) clearTimeout(geocodeTimer);
    if (value.length > 2) {
        geocodeTimer = setTimeout(() => geocodeLocation(value), 500);
    } else {
        hideMap();
    }
});

function geocodeLocation(location) {
    fetch(`/api/geocode?location=${encodeURIComponent(location)}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showMap(data.lat, data.lng, location);
                $('#lat').value = data.lat;
                $('#lng').value = data.lng;
            } else {
                hideMap();
            }
        })
        .catch(() => hideMap());
}

function showMap(lat, lng, locationName) {
    const mapDiv = $('#map');
    mapDiv.classList.remove('d-none');
    if (!map) {
        map = L.map('map').setView([lat, lng], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
    } else {
        map.setView([lat, lng], 14);
    }
    if (marker) map.removeLayer(marker);
    marker = L.marker([lat, lng]).addTo(map).bindPopup(`Alerts center: ${locationName}`).openPopup();
}

function hideMap() {
    $('#map').classList.add('d-none');
}

function normalizeIndianClient(val){
    const digits = (val||'').replace(/\D/g,'');
    const last10 = digits.slice(-10);
    if (last10.length === 10) return '+91' + last10;
    return null;
}

$('#startVerifyBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    console.log('Start verification clicked');
    const phone = $('#phone_number').value.trim();
    const normalized = normalizeIndianClient(phone);
    const lat = parseFloat($('#lat').value || '');
    const lng = parseFloat($('#lng').value || '');
    const radius = parseFloat($('#radius_km').value || '5');
    if (!normalized || isNaN(lat) || isNaN(lng)) {
        alert('Enter a valid Indian mobile number and choose a valid location.');
        return;
    }
    const btn = $('#startVerifyBtn');
    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = 'Sending...';
    try {
        const res = await fetch('/api/verify/start', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ phone_number: normalized, latitude: lat, longitude: lng, radius_km: radius })
        });
        const data = await res.json();
        if (data.success) {
            $('#verifySection').classList.remove('d-none');
            alert('Verification code sent.');
        } else {
            alert('Failed to start verification: ' + (data.error || ''));
        }
    } catch (e) {
        alert('Network error starting verification');
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
});

$('#checkVerifyBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    console.log('Check verification clicked');
    const phone = $('#phone_number').value.trim();
    const normalized = normalizeIndianClient(phone);
    const code = $('#code').value.trim();
    if (!normalized || !code) {
        alert('Enter the OTP code.');
        return;
    }
    const btn = $('#checkVerifyBtn');
    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = 'Verifying...';
    try {
        const res = await fetch('/api/verify/check', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ phone_number: normalized, code })
        });
        const data = await res.json();
        if (data.success) {
            alert('Phone verified and subscription saved. You will now receive alerts for this area.');
            window.location.href = '{{ url_for('index') }}';
        } else {
            alert('Verification failed: ' + (data.error || data.status || ''));
        }
    } catch (e) {
        alert('Network error checking verification');
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
});
</script>
{% endblock %}


